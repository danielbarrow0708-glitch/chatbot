<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Text Optimizer</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <main class="page">
    <section class="card">
      <div class="top-bar">
        <button id="refreshBtn" class="button button-secondary" type="button">Refresh page</button>
      </div>
      <header class="header">
        <h1>Text Optimizer</h1>
        <p>Paste text and get a cleaner, more human rewrite.</p>
      </header>

      <label class="label" for="inputText">Your text</label>
      <textarea id="inputText" class="textarea" rows="10" placeholder="Paste or type your text..."></textarea>

      <div class="optimize-row">
        <button id="optimizeBtn" class="button">Convert Text</button>

        <div id="spinner" class="spinner" aria-live="polite" aria-busy="true" hidden>
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <span>Converting...</span>
        </div>
      </div>

      <div id="error" class="error" hidden></div>

      <div class="output">
        <h2>Rewritten text</h2>
        <pre id="outputText" class="output-text"></pre>
      </div>

      <div class="actions">
        <button id="copyBtn" class="button button-secondary" type="button" disabled>Copy rewritten text</button>
        <span id="copyStatus" class="copy-status" aria-live="polite"></span>
      </div>
    </section>
  </main>

  <script>
    const optimizeBtn = document.getElementById("optimizeBtn");
    const inputText = document.getElementById("inputText");
    const outputText = document.getElementById("outputText");
    const spinner = document.getElementById("spinner");
    const errorBox = document.getElementById("error");
    const copyBtn = document.getElementById("copyBtn");
    const copyStatus = document.getElementById("copyStatus");
    const refreshBtn = document.getElementById("refreshBtn");
    let copyStatusTimer = null;

    function setLoading(isLoading) {
      spinner.hidden = !isLoading;
      optimizeBtn.disabled = isLoading;
    }

    function showError(message) {
      errorBox.textContent = message;
      errorBox.hidden = !message;
    }

    function setCopyStatus(message) {
      if (copyStatusTimer) {
        clearTimeout(copyStatusTimer);
      }
      copyStatus.textContent = message;
      if (message) {
        copyStatusTimer = setTimeout(() => {
          copyStatus.textContent = "";
        }, 2000);
      }
    }

    function updateCopyState() {
      const hasOutput = outputText.textContent.trim().length > 0;
      copyBtn.disabled = !hasOutput;
    }

    async function optimizeText() {
      showError("");
      outputText.textContent = "";
      setCopyStatus("");
      updateCopyState();
      const text = inputText.value.trim();
      if (!text) {
        showError("Please enter some text.");
        return;
      }

      setLoading(true);
      try {
        const response = await fetch("/optimize", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text })
        });

        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.error || "Something went wrong.");
        }

        outputText.textContent = data.result;
        updateCopyState();
      } catch (err) {
        showError(err.message || "Unable to optimize text.");
      } finally {
        setLoading(false);
      }
    }

    async function copyRewrittenText() {
      const text = outputText.textContent.trim();
      if (!text) {
        setCopyStatus("Nothing to copy.");
        return;
      }

      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
        } else {
          const tempArea = document.createElement("textarea");
          tempArea.value = text;
          tempArea.setAttribute("readonly", "");
          tempArea.style.position = "absolute";
          tempArea.style.left = "-9999px";
          document.body.appendChild(tempArea);
          tempArea.select();
          const copied = document.execCommand("copy");
          document.body.removeChild(tempArea);
          if (!copied) {
            throw new Error("Copy failed");
          }
        }
        setCopyStatus("Copied.");
      } catch (err) {
        setCopyStatus("Copy failed. Please try again.");
      }
    }

    optimizeBtn.addEventListener("click", optimizeText);
    copyBtn.addEventListener("click", copyRewrittenText);
    refreshBtn.addEventListener("click", () => {
      window.location.reload();
    });
    updateCopyState();
  </script>
</body>
</html>
